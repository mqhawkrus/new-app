<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stress Analysis App</title>
  <link rel="icon" type="image/x-icon" href="StressAppIcon.ico">
  <style>
    /* Global Reset & Base Styles (keeping existing styles) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      color: #333;
      transition: background-color 0.5s ease, color 0.5s ease;
      cursor: none;
    }
    /* Global Transitions */
    body, header, .sidebar, .results-section, .container, button, 
    .data-entry-tab, .data-entry-tab-header, .sidebar-overlay {
      transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
    }
    body { cursor: default; }
    /* Ripple effect animation */
    @keyframes ripple {
      from { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }
      to { transform: translate(-50%, -50%) scale(3); opacity: 0; }
    }
    .ripple {
      position: fixed;
      border: 2px solid rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%) scale(0);
      animation: ripple 0.6s linear forwards;
      z-index: 10000;
      width: 20px;
      height: 20px;
    }
    /* App Container */
    .app-container { display: flex; height: 100vh; }
    /* Sidebar Styling */
    .sidebar {
      width: 60px; background: #11324b; color: #ecf0f1;
      padding: 20px 10px; font-weight: bold; transition: width 0.3s ease;
      white-space: nowrap; overflow: hidden; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar:hover { width: 280px; }
    .sidebar h2 { text-align: center; margin-bottom: 20px; opacity: 0; transition: opacity 0.2s ease 0.1s; }
    .sidebar:hover h2 { opacity: 1; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li {
      padding: 12px 10px; margin: 5px 0; cursor: pointer; border-radius: 4px;
      transition: background 0.3s ease, opacity 0.2s ease; opacity: 0;
    }
    .sidebar:hover ul li { opacity: 1; }
    .sidebar ul li:hover { background: #1a497f; }
    /* Main Content Area */
    .main-content {
      flex-grow: 1; display: flex; flex-direction: column; position: relative;
    }
    /* Header */
    header {
      display: flex; align-items: center;
      background: linear-gradient(90deg, #1aa4ff, #0d8bf2); color: #ffffff;
      padding: 15px 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 2.5em; font-weight: bold; margin: 0; }
    header #toggleMode {
      margin-left: auto; width: 40px; height: 40px; border: none;
      border-radius: 50%; cursor: pointer; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      background: #ffffff; color: #1aa4ff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    header #toggleMode:hover { background: #f0f0f0; }

    @keyframes gradientPulse {
  0% {
    background-position: 0% 50%;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
  }
  50% {
    background-position: 100% 50%;
    text-shadow: 0 0 20px rgba(255,255,255,0.6), 0 0 30px rgba(255,255,255,0.4);
  }
  100% {
    background-position: 0% 50%;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
  }
}

.wavy-text {
  background-image: linear-gradient(
    90deg,
    #ffffff 0%,
    #a0d8ff 25%,
    #1aa4ff 50%,
    #a0d8ff 75%,
    #ffffff 100%
  );
  background-size: 400% 400%;
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  animation: gradientPulse 8s ease infinite;
  letter-spacing: 2px;
}

    /* Content Area */
    .content-area { flex-grow: 1; display: flex; overflow: hidden; }
    .results-section {
      overflow-y: auto; padding: 20px; background: #ecf0f1; width: 60%;
    }
    /* Data Entry Tab */
    .data-entry-tab {
      position: fixed; top: 50%; right: -320px; transform: translateY(-50%);
      width: 300px; background: #fff; border-left: 1px solid #acbac3;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2); z-index: 1000; transition: right 0.3s ease;
    }
    .data-entry-tab:hover { right: 0; }
    .data-entry-tab-header {
      position: absolute; top: 0; left: -40px; width: 40px; height: 100%;
      background: #2c3e50; color: #fff; text-align: center; line-height: 50px;
      writing-mode: vertical-rl; cursor: pointer; font-weight: bold;
      border-top-left-radius: 4px; border-bottom-left-radius: 4px;
    }
    .data-entry-tab-content { padding: 20px; overflow-y: auto; max-height: 90vh; }
    /* Container Styles */
    .container {
      background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label { display: block; margin-top: 10px; color: #2c3e50; }
    input[type="number"], input[type="text"], textarea, select {
      width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #bdc3c7; border-radius: 4px;
    }
    button {
      margin-top: 15px; padding: 10px; width: 100%; border: none;
      border-radius: 4px; background: #14d970; color: #fff;
      font-weight: bold; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0fae5d; }
    .alt-btn { background: #e74c3c; }
    .alt-btn:hover { background: #c0392b; }
    .entry {
      border: 1px solid #bdc3c7; padding: 10px; margin: 10px 0; border-radius: 4px; background: #ecf0f1;
    }
    /* User List in User Data Overlay */
    .user-list { margin-top: 20px; }
    .user-item {
      display: flex; align-items: center; margin-bottom: 10px; padding: 5px;
      border: 1px solid #bdc3c7; border-radius: 4px; background: #f9f9f9;
    }
    .user-photo {
      width: 50px; height: 50px; object-fit: cover; border-radius: 50%;
      margin-right: 10px; border: 1px solid #ccc;
    }
    .user-details { flex-grow: 1; }
    .delete-user-btn {
      background: #e74c3c; border: none; color: #fff; padding: 5px 10px;
      cursor: pointer; border-radius: 4px;
    }
    /* Sidebar Overlay */
    .sidebar-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #ffffff; overflow-y: auto; padding: 140px 20px 20px;
      opacity: 0; visibility: hidden; transform: translateY(-20px);
      transition: opacity 0.5s ease, transform 0.5s ease, visibility 0.5s ease;
      z-index: 9999;
    }
    .sidebar-overlay.active {
      opacity: 1; visibility: visible; transform: translateY(0);
    }
    .sidebar-overlay::before {
      content: "";
      position: absolute; top: 0; left: 0; width: 100%; height: 140px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%231aa4ff' fill-opacity='1' d='M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,90.7C672,85,768,107,864,112C960,117,1056,107,1152,96C1248,85,1344,75,1392,69.3L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z'%3E%3C/path%3E%3C/svg%3E") no-repeat;
      background-size: cover; z-index: -1;
    }
    /* Dark Mode Styles */
    body.dark-mode {
      background: #121212; color: #e0e0e0;
    }
    body.dark-mode header {
      background: linear-gradient(45deg, #1a73e8, #d93025); border-bottom: 3px solid #fbbc05;
    }
    body.dark-mode .sidebar {
      background: #202124; color: #e0e0e0; border-right: 2px solid #34a853;
    }
    body.dark-mode .sidebar ul li:hover { background: #3c4043; }
    body.dark-mode .results-section { background: #202124; color: #e0e0e0; }
    body.dark-mode .container {
      background: #303134; color: #e0e0e0; border: 1px solid #fbbc05;
      box-shadow: 0 2px 8px rgba(251, 188, 5, 0.5);
    }
    body.dark-mode .data-entry-tab { background: #303134; color: #e0e0e0; border-left: 1px solid #fbbc05; }
    body.dark-mode .data-entry-tab-header { background: #3c4043; }
    body.dark-mode header h1 { color: #ffffff; }
    body.dark-mode button {
      background: linear-gradient(45deg, #1a73e8, #d93025); color: #ffffff; border: none;
    }
    body.dark-mode button:hover {
      background: linear-gradient(45deg, #1669c1, #c5221f);
    }
    body.dark-mode header #toggleMode {
      background: #202124; color: #e0e0e0; border: 2px solid #fbbc05;
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f0f0f0; }
    ::-webkit-scrollbar-thumb {
      background: #c0c0c0; border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
  </style>
  
</head>
<body>

  <div class="app-container">
    <!-- Sidebar Menu -->
    <div class="sidebar">
      <h2>Menu</h2>
      <ul>
        <li onclick="openSidebarOverlay('historyOverlay')">History</li>
        <li onclick="openSidebarOverlay('otherTestOverlay')">Other Test (Coming Soon)</li>
        <li onclick="openSidebarOverlay('aiOverlay')">AI Analysis (Coming Soon)</li>
        <li onclick="openSidebarOverlay('userDataOverlay')">User Data</li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Header with Wavy Text -->
      <header>
        <header>
          <h1 class="wavy-text">Stress Analysis App</h1>
          
        </header>
        <button id="toggleMode" onclick="toggleDarkMode()">â˜¾</button>
      </header>
      
      <!-- Content Area: Left = Results, Right = Data Entry -->
      <div class="content-area">
        <!-- Results Section -->
        <div class="results-section">
          <!-- Report Summary -->
          <div class="container">
            <h2>Report Summary</h2>
            <button type="button" onclick="generateReport()">Generate Report</button>
            <!-- Download Report as Word Button -->
            <button type="button" onclick="downloadReport()">Download as Word File</button>
            <div id="reportResult" style="margin-top:20px;"></div>
          </div>
          <!-- Stored Entries -->
          <div class="container">
            <h2>Stored Entries</h2>
            <div id="entries"></div>
            <button type="button" onclick="clearEntries()">Clear All Entries</button>
          </div>
        </div>
        
        <!-- Data Entry Tab -->
        <div class="data-entry-tab">
          <div class="data-entry-tab-header">Data Entry</div>
          <div class="data-entry-tab-content">
            <!-- Step 1: Physiological Data -->
            <div id="step1" class="container">
              <h2>Enter Physiological Data</h2>
              <form id="physioForm">
                <!-- Select User -->
                <label for="selectedUser">Select User:</label>
                <select id="selectedUser">
                  <option value="">-- Select a User --</option>
                </select>
                
                <label for="heartRate">Heart Rate (bpm):</label>
                <input type="number" id="heartRate" name="heartRate" placeholder="e.g., 70" required>
          
                <label for="bloodPressure">Blood Pressure (Systolic/Diastolic):</label>
                <input type="text" id="bloodPressure" name="bloodPressure" placeholder="e.g., 120/80" required>
          
                <label for="respiratoryRate">Respiratory Rate (breaths/min):</label>
                <input type="number" id="respiratoryRate" name="respiratoryRate" placeholder="e.g., 16" required>
          
                <button type="button" onclick="calculateRoughStress()">Next: Calculate Rough Stress Level</button>
              </form>
            </div>
          
            <!-- Step 2: Emotional Assessment (Using Options) -->
            <div id="step2" class="container" style="display:none;">
              <h2>Emotional Assessment</h2>
              <p>Your rough stress level is: <strong><span id="roughStress"></span></strong></p>
              <form id="emotionalForm">
                <label for="feelingToday">How are you feeling today?</label>
                <select id="feelingToday" name="feelingToday" required>
                  <option value="">Select a rating</option>
                  <option value="1">1 - Very Bad</option>
                  <option value="2">2 - Bad</option>
                  <option value="3">3 - Neutral</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Very Good</option>
                </select>
                
                <label for="sleepRating">How's your sleep been?</label>
                <select id="sleepRating" name="sleepRating" required>
                  <option value="">Select a rating</option>
                  <option value="1">1 - Very Poor</option>
                  <option value="2">2 - Poor</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
                
                <label for="manageableStress">How manageable is your stress?</label>
                <select id="manageableStress" name="manageableStress" required>
                  <option value="">Select a rating</option>
                  <option value="1">1 - Not Manageable</option>
                  <option value="2">2</option>
                  <option value="3">3 - Neutral</option>
                  <option value="4">4</option>
                  <option value="5">5 - Very Manageable</option>
                </select>
                
                <label for="socialConnections">Social connections feel...</label>
                <select id="socialConnections" name="socialConnections" required>
                  <option value="">Select a rating</option>
                  <option value="1">1 - Isolated</option>
                  <option value="2">2</option>
                  <option value="3">3 - Neutral</option>
                  <option value="4">4</option>
                  <option value="5">5 - Well Connected</option>
                </select>
                
                <label for="motivationLevel">Daily motivation level?</label>
                <select id="motivationLevel" name="motivationLevel" required>
                  <option value="">Select a rating</option>
                  <option value="1">1 - Low</option>
                  <option value="2">2</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4</option>
                  <option value="5">5 - High</option>
                </select>
                
                <button type="button" onclick="calculateFinalStress()">Next: Submit Answers</button>
              </form>
            </div>
          
            <!-- Step 3: Final Analysis and Recommendations -->
            <div id="step3" class="container" style="display:none;">
              <h2>Your Stress Analysis</h2>
              <p><strong>Final Stress Level:</strong> <span id="finalStress"></span></p>
              <h3>Recommended Therapies</h3>
              <ul id="therapies"></ul>
              <!-- Therapist recommendation will be appended here -->
              <p id="therapistRecommendation"></p>
              <!-- AI Integration Placeholder -->
              <div class="container" style="background:#e8f4fa; margin-top:20px;">
                <h4>AI Analysis</h4>
                <p>(AI integration will appear here)</p>
              </div>
              <button type="button" onclick="storeData()">Save Entry</button>
              <button type="button" class="alt-btn" onclick="resetTest()">Start Over</button>
            </div>
          </div>
        </div>
    
        <!-- Sidebar Overlay Views -->
        <div id="historyOverlay" class="sidebar-overlay">
          <h2>History</h2>
          <div id="sidebarEntries"></div>
          <button type="button" onclick="clearEntries()">Clear All Entries</button>
          <button type="button" onclick="closeSidebarOverlay()">Back</button>
        </div>
        <div id="otherTestOverlay" class="sidebar-overlay">
          <h2>Other Test (Coming Soon)</h2>
          <p>This section will include additional tests in the future.</p>
          <button type="button" onclick="closeSidebarOverlay()">Back</button>
        </div>
        <div id="aiOverlay" class="sidebar-overlay">
          <h2>AI Analysis (Coming Soon)</h2>
          <button style="font-size: 50px;display: inline-block;" onclick="window.location.href='dowload file/ai.html'">AI</button>
          <button type="button" onclick="closeSidebarOverlay()">Back</button>
        </div>
        <!-- User Data Overlay -->
        <div id="userDataOverlay" class="sidebar-overlay">
          <h2>User Data</h2>
          <div class="container">
            <form id="userDataForm">
              <label for="userName">Name:</label>
              <input type="text" id="userName" name="userName" placeholder="Enter Name" required>
              
              <label for="userGender">Gender:</label>
              <input type="text" id="userGender" name="userGender" placeholder="Enter Gender" required>
              
              <label for="userPhone">Phone Number:</label>
              <input type="text" id="userPhone" name="userPhone" placeholder="Enter Phone Number" required>
              
              <label for="userQID">QID:</label>
              <input type="text" id="userQID" name="userQID" placeholder="Enter QID" required>
              
              <label for="userPhoto">Photo:</label>
              <input type="file" id="userPhoto" name="userPhoto" accept="image/*">
              
              <button type="button" onclick="saveUserData()">Save User Data</button>
            </form>
          </div>
          <!-- Render Saved Users -->
          <div class="container user-list" id="savedUsersList">
            <!-- Dynamically generated list of users will appear here -->
          </div>
          <button type="button" onclick="closeSidebarOverlay()">Back</button>
        </div>
      </div>
    </div>
    <script>
      // Ripple effect on click
      document.addEventListener('click', (e) => {
        const ripple = document.createElement('div');
        ripple.className = 'ripple';
        ripple.style.left = e.clientX + 'px';
        ripple.style.top = e.clientY + 'px';
        document.body.appendChild(ripple);
        setTimeout(() => { ripple.remove(); }, 600);
      });

      // Sidebar Overlay Functions
      function openSidebarOverlay(overlayId) {
        document.getElementById(overlayId).classList.add("active");
        if (overlayId === 'historyOverlay') { showSidebarEntries(); }
        if (overlayId === 'userDataOverlay') { renderSavedUsers(); }
      }
      function closeSidebarOverlay() {
        var overlays = document.getElementsByClassName("sidebar-overlay");
        for (var i = 0; i < overlays.length; i++) {
          overlays[i].classList.remove("active");
        }
      }
      
      // Multi-step Form Functions
      function calculateRoughStress() {
        var heartRate = parseFloat(document.getElementById('heartRate').value);
        var respiratoryRate = parseFloat(document.getElementById('respiratoryRate').value);
        if (isNaN(heartRate) || isNaN(respiratoryRate)) {
          alert("Please enter valid physiological data.");
          return;
        }
        var roughStress = Math.round((heartRate / 10) + (respiratoryRate / 5));
        document.getElementById('roughStress').textContent = roughStress;
        document.getElementById('step1').style.display = "none";
        document.getElementById('step2').style.display = "block";
      }
      
      function calculateFinalStress() {
        var roughStress = parseInt(document.getElementById('roughStress').textContent);
        // Retrieve emotional ratings from select options
        var feelingToday = parseFloat(document.getElementById('feelingToday').value);
        var sleepRating = parseFloat(document.getElementById('sleepRating').value);
        var manageableStress = parseFloat(document.getElementById('manageableStress').value);
        var socialConnections = parseFloat(document.getElementById('socialConnections').value);
        var motivationLevel = parseFloat(document.getElementById('motivationLevel').value);

        if (isNaN(feelingToday) || isNaN(sleepRating) || isNaN(manageableStress) || isNaN(socialConnections) || isNaN(motivationLevel)) {
          alert("Please provide valid ratings for all emotional questions.");
          return;
        }
        // For each question, a lower rating means more stress.
        // Calculate an emotional stress score using (6 - rating) for each.
        var emotionalStress = (6 - feelingToday) + (6 - sleepRating) + (6 - manageableStress) + (6 - socialConnections) + (6 - motivationLevel);
        // Normalize: if all answers are best (5), emotionalStress will be 5.
        // Scale the adjustment by subtracting the baseline (5) and dividing by 2.
        var emotionalAdjustment = Math.round((emotionalStress - 5) / 2);
        
        var finalStress = roughStress + emotionalAdjustment;
        document.getElementById('finalStress').textContent = finalStress;
        var therapiesList = document.getElementById('therapies');
        therapiesList.innerHTML = "";
        var therapist = "";
        if (finalStress <= 8) {
          therapiesList.innerHTML = "<li>Deep breathing exercises</li><li>Light exercise or a walk</li>";
          therapist = "Wellness Coach";
        } else if (finalStress <= 12) {
          therapiesList.innerHTML = "<li>Meditation and mindfulness</li><li>Yoga or stretching</li><li>Talk to a friend</li>";
          therapist = "Stress Management Counselor";
        } else {
          therapiesList.innerHTML = "<li>Consult a professional therapist</li><li>Consider stress management workshops</li><li>Engage in regular relaxation techniques</li>";
          therapist = "Clinical Psychologist";
        }
        // Append therapist recommendation
        var therapistDiv = document.getElementById('therapistRecommendation');
        therapistDiv.innerHTML = "<strong>Recommended Therapist:</strong> " + therapist;
        
        document.getElementById('step2').style.display = "none";
        document.getElementById('step3').style.display = "block";
      }
      
      // Save User Data with Photo Functionality
      function saveUserData() {
        var user = {
          name: document.getElementById('userName').value,
          gender: document.getElementById('userGender').value,
          phone: document.getElementById('userPhone').value,
          qid: document.getElementById('userQID').value,
          photo: null
        };
        var photoInput = document.getElementById('userPhoto');
        if(photoInput.files && photoInput.files[0]){
          var reader = new FileReader();
          reader.onload = function(e) {
            user.photo = e.target.result; // Base64 image
            finishSaveUser(user);
          }
          reader.readAsDataURL(photoInput.files[0]);
        } else {
          finishSaveUser(user);
        }
      }
      function finishSaveUser(user) {
        var users = localStorage.getItem('userData');
        users = users ? JSON.parse(users) : [];
        users.push(user);
        localStorage.setItem('userData', JSON.stringify(users));
        alert("User data saved!");
        document.getElementById('userDataForm').reset();
        loadUsers(); // Refresh the dropdown in the physiological data form
        renderSavedUsers(); // Refresh the saved users list
      }
      
      // Load Users into the Selection Dropdown
      function loadUsers() {
        var userSelect = document.getElementById('selectedUser');
        userSelect.innerHTML = '<option value="">-- Select a User --</option>';
        var users = localStorage.getItem('userData');
        users = users ? JSON.parse(users) : [];
        users.forEach(function(user, index) {
          var option = document.createElement('option');
          option.value = index;
          option.textContent = user.name;
          userSelect.appendChild(option);
        });
      }
      
      // Render Saved Users in the User Data Overlay with Delete Buttons
      function renderSavedUsers() {
        var container = document.getElementById('savedUsersList');
        var users = localStorage.getItem('userData');
        users = users ? JSON.parse(users) : [];
        container.innerHTML = "";
        if(users.length === 0){
          container.innerHTML = "<p>No users saved yet.</p>";
          return;
        }
        users.forEach(function(user, index){
          var userDiv = document.createElement('div');
          userDiv.className = "user-item";
          if(user.photo){
            var img = document.createElement('img');
            img.src = user.photo;
            img.alt = user.name + " Photo";
            img.className = "user-photo";
            userDiv.appendChild(img);
          }
          var detailsDiv = document.createElement('div');
          detailsDiv.className = "user-details";
          detailsDiv.innerHTML = "<strong>" + user.name + "</strong><br>" + user.phone;
          userDiv.appendChild(detailsDiv);
          var deleteBtn = document.createElement('button');
          deleteBtn.textContent = "Delete";
          deleteBtn.className = "delete-user-btn";
          deleteBtn.onclick = function(){ deleteUser(index); };
          userDiv.appendChild(deleteBtn);
          container.appendChild(userDiv);
        });
      }
      
      // Delete a user from localStorage
      function deleteUser(index) {
        if(confirm("Are you sure you want to delete this user?")){
          var users = localStorage.getItem('userData');
          users = users ? JSON.parse(users) : [];
          users.splice(index, 1);
          localStorage.setItem('userData', JSON.stringify(users));
          loadUsers();
          renderSavedUsers();
        }
      }
      
      // Data Storage Function for Stress Entries
      function storeData() {
        var selectedUserIndex = document.getElementById('selectedUser').value;
        var users = localStorage.getItem('userData');
        var selectedUser = (users && selectedUserIndex !== "") ? JSON.parse(users)[selectedUserIndex] : null;
        var entry = {
          timestamp: new Date().toLocaleString(),
          heartRate: document.getElementById('heartRate').value,
          bloodPressure: document.getElementById('bloodPressure').value,
          respiratoryRate: document.getElementById('respiratoryRate').value,
          roughStress: document.getElementById('roughStress').textContent,
          finalStress: document.getElementById('finalStress').textContent,
          feelingToday: document.getElementById('feelingToday').value,
          sleepRating: document.getElementById('sleepRating').value,
          manageableStress: document.getElementById('manageableStress').value,
          socialConnections: document.getElementById('socialConnections').value,
          motivationLevel: document.getElementById('motivationLevel').value,
          recommendedTherapist: document.getElementById('therapistRecommendation').textContent.replace("Recommended Therapist: ", ""),
          user: selectedUser
        };
        var entries = localStorage.getItem('stressEntries');
        entries = entries ? JSON.parse(entries) : [];
        entries.push(entry);
        localStorage.setItem('stressEntries', JSON.stringify(entries));
        alert("Entry saved!");
        resetTest();
        showEntries();
      }
      
      function resetTest() {
        document.getElementById('physioForm').reset();
        document.getElementById('emotionalForm').reset();
        document.getElementById('step1').style.display = "block";
        document.getElementById('step2').style.display = "none";
        document.getElementById('step3').style.display = "none";
      }
      
      // Data View Functions (Results Section)
      function loadEntries() {
        var entries = localStorage.getItem('stressEntries');
        return entries ? JSON.parse(entries) : [];
      }
      function loadEntriesToDiv(divId) {
        var container = document.getElementById(divId);
        var entries = loadEntries();
        container.innerHTML = "";
        if (entries.length === 0) {
          container.innerHTML = "<p>No entries stored yet.</p>";
        } else {
          entries.forEach(function(entry) {
            var div = document.createElement('div');
            div.className = "entry";
            div.innerHTML = "<strong>Date:</strong> " + entry.timestamp + "<br>" +
                            (entry.user ? "<strong>User:</strong> " + entry.user.name + "<br>" : "<strong>User:</strong> N/A<br>") +
                            "<strong>Heart Rate:</strong> " + entry.heartRate + " bpm<br>" +
                            "<strong>Blood Pressure:</strong> " + entry.bloodPressure + "<br>" +
                            "<strong>Respiratory Rate:</strong> " + entry.respiratoryRate + " breaths/min<br>" +
                            "<strong>Rough Stress Level:</strong> " + entry.roughStress + "<br>" +
                            "<strong>Final Stress Level:</strong> " + entry.finalStress + "<br>" +
                            "<strong>Feeling Today:</strong> " + entry.feelingToday + "<br>" +
                            "<strong>Sleep Rating:</strong> " + entry.sleepRating + "<br>" +
                            "<strong>Manageable Stress:</strong> " + entry.manageableStress + "<br>" +
                            "<strong>Social Connections:</strong> " + entry.socialConnections + "<br>" +
                            "<strong>Motivation Level:</strong> " + entry.motivationLevel + "<br>" +
                            "<strong>Recommended Therapist:</strong> " + entry.recommendedTherapist;
            container.appendChild(div);
          });
        }
      }
      function showEntries() { loadEntriesToDiv('entries'); }
      function clearEntries() {
        if (confirm("Are you sure you want to clear all stored entries?")) {
          localStorage.removeItem('stressEntries');
          showEntries();
          loadEntriesToDiv('sidebarEntries');
        }
      }
      
      // Generate Report Function
      function generateReport() {
        var entries = loadEntries();
        var reportDiv = document.getElementById('reportResult');
        reportDiv.innerHTML = "";
        if (entries.length === 0) {
          reportDiv.innerHTML = "<p>No data available to generate a report.</p>";
          return;
        }
        var totalEntries = entries.length;
        var sumHeartRate = 0, sumRespRate = 0, sumFinalStress = 0;
        entries.forEach(function(entry) {
          sumHeartRate += parseFloat(entry.heartRate);
          sumRespRate += parseFloat(entry.respiratoryRate);
          sumFinalStress += parseFloat(entry.finalStress);
        });
        var avgHeartRate = (sumHeartRate / totalEntries).toFixed(1);
        var avgRespRate = (sumRespRate / totalEntries).toFixed(1);
        var avgFinalStress = (sumFinalStress / totalEntries).toFixed(1);
        var reportHTML = "<h1 class='report-title'>Stress Analysis Report</h1>";
        reportHTML += "<h2 class='section-title'>Overall Summary</h2>";
        reportHTML += "<p>Total Entries: " + totalEntries + "</p>";
        reportHTML += "<p>Average Heart Rate: " + avgHeartRate + " bpm</p>";
        reportHTML += "<p>Average Respiratory Rate: " + avgRespRate + " breaths/min</p>";
        reportHTML += "<p>Average Final Stress Level: " + avgFinalStress + "</p>";
        reportDiv.innerHTML = reportHTML;
      }
      
      // Download Report as Word File Function with Enhanced Styles
      function downloadReport() {
        var reportContent = document.getElementById('reportResult').innerHTML;
        if(reportContent.trim() === ""){
          alert("Please generate the report first.");
          return;
        }
        // Enhanced Word-compatible HTML with inline CSS for better formatting
        var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                     "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                     "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Stress Analysis Report</title>" +
                     "<style>" +
                     "body { font-family: 'Segoe UI', sans-serif; margin: 40px; }" +
                     "h1.report-title { text-align: center; font-size: 24pt; color: #11324b; margin-bottom: 20px; }" +
                     "h2.section-title { font-size: 18pt; color: #0d8bf2; border-bottom: 2px solid #1aa4ff; padding-bottom: 5px; margin-top: 30px; }" +
                     "p { font-size: 12pt; line-height: 1.5; margin-top: 10px; }" +
                     "</style>" +
                     "</head><body>";
        var footer = "</body></html>";
        var sourceHTML = header + reportContent + footer;
        var blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = 'StressReport.doc';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // For Sidebar History Overlay
      function showSidebarEntries() { loadEntriesToDiv('sidebarEntries'); }
      
      // Resizable Divider (if needed)
      (function() {
        const resizer = document.querySelector('.resizer');
        const contentArea = document.querySelector('.content-area');
        const resultsSection = document.querySelector('.results-section');
        let isResizing = false;
    
        resizer && resizer.addEventListener('mousedown', function(e) {
          isResizing = true;
        });
    
        document.addEventListener('mousemove', function(e) {
          if (!isResizing) return;
          const contentRect = contentArea.getBoundingClientRect();
          let newResultsWidth = e.clientX - contentRect.left;
          if(newResultsWidth < 50) newResultsWidth = 50;
          if(newResultsWidth > contentRect.width - 50 - (resizer ? resizer.offsetWidth : 0)) {
            newResultsWidth = contentRect.width - 50 - (resizer ? resizer.offsetWidth : 0);
          }
          resultsSection.style.width = newResultsWidth + 'px';
        });
    
        document.addEventListener('mouseup', function(e) {
          isResizing = false;
        });
      })();
      
      // Dark Mode Toggle Function with Icon Change
      function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const toggleButton = document.getElementById('toggleMode');
        if(document.body.classList.contains('dark-mode')){
            toggleButton.innerHTML = 'â˜€';
        } else {
            toggleButton.innerHTML = 'â˜¾';
        }
      }
      
      // Load initial entries and users on page load
      window.onload = function() {
        showEntries();
        loadUsers();
      }
    </script>
</body>
</html>
